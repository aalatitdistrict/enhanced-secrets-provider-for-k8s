#!/bin/bash -ex

source test/bootstrap.env

# summon environment variable
export CONJUR_MAJOR_VERSION=4

function runScriptWithSummon() {
    summon --environment $PLATFORM -f ./summon/secrets.yml $1
}

RUN_IN_DOCKER=false
DEMO=false
while true ; do
  case "$1" in
    --docker ) RUN_IN_DOCKER=true ; shift ;;
    --demo ) DEMO=true ; shift ;;
     * ) if [ -z "$1" ]; then break; else echo "$1 is not a valid option"; exit 1; fi;;
  esac
done

cd test
if [[ $DEMO = true ]]; then
  runScriptWithSummon ./run_demo.sh
elif [[ $RUN_IN_DOCKER = true ]]; then
  # this option cannot run locally due to lack of docker credentials. It works only in the Jenkins pipeline
  runScriptWithSummon ./test_in_docker.sh
else
  runScriptWithSummon ./test_local.sh
fi
